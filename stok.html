<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDV Futurista Categorias</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<style>
body{
    background: linear-gradient(120deg,#0f172a,#1e293b);
    color:white;
    padding:40px 0;
    font-family:'Segoe UI',sans-serif;
}
.card-custom{
    background:#1e293b;
    border-radius:20px;
    padding:30px;
    box-shadow:0 0 40px rgba(0,255,200,0.25);
}
h2{ color:#00ffc3; }

.categoria-box{
    margin-top:40px;
    background:#0f172a;
    padding:20px;
    border-radius:15px;
    box-shadow:0 0 20px rgba(0,255,200,0.15);
}

.categoria-title{
    color:#00ffc3;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.edit-icon{
    cursor:pointer;
    font-size:18px;
}
</style>
</head>
<body>

<div class="container">
<div class="card-custom">

<h2 class="text-center mb-4">Cadastro de Produtos</h2>

<div class="row g-3">

<div class="col-md-3">
<input type="text" id="categoria" class="form-control" placeholder="Categoria (opcional)">
</div>

<div class="col-md-3">
<input type="text" id="marca" class="form-control" placeholder="Marca">
</div>

<div class="col-md-3">
<input type="text" id="produto" class="form-control" placeholder="Produto">
</div>

<div class="col-md-3">
<input type="text" id="codigo" class="form-control" placeholder="CÃ³digo">
</div>

<div class="col-12 d-flex gap-2">
<button class="btn btn-primary flex-fill" id="btnCadastrar" onclick="acaoPrincipal()">Cadastrar</button>
</div>

</div>

<hr class="my-4">

<input type="text" id="buscaGlobal" class="form-control mb-4" placeholder="ðŸ” Buscar produto...">

<div id="areaCategorias"></div>

</div>
</div>

<!-- Modal Editar Categoria -->
<div class="modal fade" id="modalEditarCategoria" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content bg-dark text-white">
<div class="modal-header">
<h5 class="modal-title">Editar Categoria</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<input type="text" id="novaCategoria" class="form-control">
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button class="btn btn-success" onclick="salvarNomeCategoria()">Salvar</button>
</div>
</div>
</div>
</div>

<script>

var produtos = JSON.parse(localStorage.getItem("produtos")) || []
var editandoIndex = null
var categoriaAntiga = null
var tabelas = []
var modalEditar = null

document.addEventListener("DOMContentLoaded", function(){
    modalEditar = new bootstrap.Modal(document.getElementById('modalEditarCategoria'))
    listar()
})

function salvarLocal(){
    localStorage.setItem("produtos", JSON.stringify(produtos))
}

function limparCampos(){
    categoria.value=""
    marca.value=""
    produto.value=""
    codigo.value=""
    editandoIndex=null
    btnCadastrar.innerText="Cadastrar"
}

function acaoPrincipal(){
    if(editandoIndex!==null) salvarEdicao()
    else cadastrar()
}

function cadastrar(){

    if(!produto.value || !codigo.value){
        alert("Preencha Produto e CÃ³digo!")
        return
    }

    let categoriaFinal = categoria.value.trim()===""
        ? "Sem Categoria"
        : categoria.value.trim()

    produtos.push({
        categoria: categoriaFinal,
        marca: marca.value,
        produto: produto.value,
        codigo: codigo.value
    })

    salvarLocal()
    limparCampos()
    listar()
}

function editar(i){
    editandoIndex=i
    categoria.value=produtos[i].categoria==="Sem Categoria"?"":produtos[i].categoria
    marca.value=produtos[i].marca
    produto.value=produtos[i].produto
    codigo.value=produtos[i].codigo
    btnCadastrar.innerText="Salvar AlteraÃ§Ã£o"
    window.scrollTo({top:0,behavior:"smooth"})
}

function salvarEdicao(){

    let categoriaFinal = categoria.value.trim()===""
        ? "Sem Categoria"
        : categoria.value.trim()

    produtos[editandoIndex]={
        categoria: categoriaFinal,
        marca: marca.value,
        produto: produto.value,
        codigo: codigo.value
    }

    salvarLocal()
    limparCampos()
    listar()
}

function excluir(i){
    if(confirm("Deseja excluir?")){
        produtos.splice(i,1)
        salvarLocal()
        listar()
    }
}

function abrirEditarCategoria(nome){
    categoriaAntiga = nome.trim()
    novaCategoria.value = nome==="Sem Categoria"?"":nome
    modalEditar.show()
}

function salvarNomeCategoria(){

    let novoNome = novaCategoria.value.trim()===""
        ? "Sem Categoria"
        : novaCategoria.value.trim()

    produtos.forEach(p=>{
        if(p.categoria.trim() === categoriaAntiga){
            p.categoria = novoNome
        }
    })

    salvarLocal()
    listar()
    modalEditar.hide()
}

function listar(){

    tabelas.forEach(t=>t.destroy())
    tabelas=[]
    areaCategorias.innerHTML=""

    var categorias={}

    produtos.forEach((p,i)=>{
        if(!categorias[p.categoria]) categorias[p.categoria]=[]
        categorias[p.categoria].push({...p,index:i})
    })

    let ordemCategorias = Object.keys(categorias).sort((a,b)=>{
        if(a==="Sem Categoria") return 1
        if(b==="Sem Categoria") return -1
        return a.localeCompare(b)
    })

    ordemCategorias.forEach(cat=>{
        let id="tab_"+cat.replace(/\s/g,"_")

        areaCategorias.innerHTML+=`
        <div class="categoria-box">
        <h4 class="categoria-title">
            ${cat}
            <span class="edit-icon" onclick="abrirEditarCategoria('${cat}')">ðŸ–Š</span>
        </h4>
        <div class="table-responsive">
        <table id="${id}" class="table table-dark table-striped table-bordered w-100">
        <thead>
        <tr>
        <th>Marca</th>
        <th>Produto</th>
        <th>CÃ³digo</th>
        <th>AÃ§Ãµes</th>
        </tr>
        </thead>
        <tbody>
        ${categorias[cat].map(p=>`
        <tr>
        <td>${p.marca||""}</td>
        <td>${p.produto}</td>
        <td>${p.codigo}</td>
        <td>
        <button class="btn btn-sm btn-warning" onclick="editar(${p.index})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="excluir(${p.index})">Excluir</button>
        </td>
        </tr>
        `).join("")}
        </tbody>
        </table>
        </div>
        </div>
        `

        let tabela=$('#'+id).DataTable({
            paging:false,
            info:false,
            searching:true,
            dom:'t',
            responsive:true
        })

        tabelas.push(tabela)
    })
}

</script>

</body>
</html>