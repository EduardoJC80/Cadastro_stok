<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDV Futurista Scroll</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Html5 QR e JsBarcode -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<style>
body {
    background: linear-gradient(120deg, #0f172a, #1e293b);
    color: white;
    min-height: 100vh;
    padding: 30px 0;
    font-family: 'Segoe UI', sans-serif;
}

.card {
    border-radius: 20px;
    background: rgba(30,41,59,0.95);
    padding: 30px;
    box-shadow: 0 0 40px rgba(0,255,200,0.3);
}

h2 { color: #00ffc3; }

.btn-edit { background: #facc15; color: black; }
.btn-delete { background: #ef4444; color: white; }

.codigo-click {
    color: #00ffc3;
    font-weight: bold;
    cursor: pointer;
}

.table-scroll {
    max-height: 300px;
    overflow-y: auto;
}

.modal-bg {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:black;
    display:none;
    justify-content:center;
    align-items:center;
    z-index: 9999;
}

#reader { width:100%; }
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 class="text-center mb-4">Cadastro PDV Futurista</h2>

        <div class="mb-3">
            <input type="text" id="marca" class="form-control" placeholder="Marca">
        </div>
        <div class="mb-3">
            <input type="text" id="produto" class="form-control" placeholder="Produto">
        </div>
        <div class="mb-3">
            <input type="text" id="codigo" class="form-control" placeholder="CÃ³digo do Produto">
        </div>

        <div class="d-flex gap-2 flex-wrap mb-4">
            <button class="btn btn-success flex-fill" onclick="abrirCamera()">ðŸ“· Ler CÃ³digo</button>
            <button class="btn btn-primary flex-fill" id="btnCadastrar" onclick="acaoPrincipal()">Cadastrar</button>
            <button class="btn btn-danger flex-fill" id="btnLimpar" onclick="limparCampos()" style="display:none">Limpar</button>
        </div>

        <h4 class="text-center">Produtos Cadastrados</h4>

        <!-- Busca externa -->
        <div class="mb-3 text-end">
            <input type="text" id="buscaExterna" class="form-control"
                   placeholder="ðŸ” Buscar produto..."
                   style="max-width:300px; margin-left:auto;">
        </div>

        <div class="table-scroll">
            <table id="produtosTable" class="table table-dark table-striped table-hover table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Marca</th>
                        <th>Produto</th>
                        <th>CÃ³digo</th>
                        <th>AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Camera -->
<div class="modal-bg" id="modalCamera">
    <div class="card p-3" style="width:350px;text-align:center;">
        <h5>Ler CÃ³digo de Barras</h5>
        <div id="reader"></div>
        <button class="btn btn-secondary mt-3" onclick="fecharCamera()">Cancelar</button>
    </div>
</div>

<!-- Modal Barcode Tela Cheia -->
<div class="modal-bg" id="modalBarcode">
    <div style="position:absolute; top:20px; right:20px;">
        <button class="btn btn-light" onclick="fecharBarcode()">Fechar âœ–</button>
    </div>

    <div style="display:flex; flex-direction:column;
                justify-content:center;
                align-items:center;
                height:100%; width:100%;">

        <svg id="barcode" style="width:90%; height:200px;"></svg>
        <h3 id="codigoTexto" style="color:white; margin-top:20px;"></h3>
    </div>
</div>

<script>
const TOKEN = "AVqJ1IQT43zeLcJq3kMwYg"
var produtos = JSON.parse(localStorage.getItem("produtos")) || []
var html5QrCode = null
var editandoIndex = null
var table = null

function beep(){
    var ctx = new (window.AudioContext || window.webkitAudioContext)()
    var osc = ctx.createOscillator()
    osc.frequency.setValueAtTime(900, ctx.currentTime)
    osc.connect(ctx.destination)
    osc.start()
    setTimeout(()=>osc.stop(),120)
}

function salvarLocal(){
    localStorage.setItem("produtos", JSON.stringify(produtos))
}

function atualizarBotaoLimpar(){
    btnLimpar.style.display =
        (marca.value || produto.value || codigo.value) ? 'block':'none'
}

function limparCampos(){
    marca.value=''
    produto.value=''
    codigo.value=''
    editandoIndex=null
    btnCadastrar.innerText="Cadastrar"
    atualizarBotaoLimpar()
}

async function buscarProduto(cod){
    if(!cod || cod.length<8) return
    try{
        const resp=await fetch(`https://api.cosmos.bluesoft.com.br/gtins/${cod}`,{
            headers:{ "X-Cosmos-Token": TOKEN }
        })
        if(!resp.ok) return
        const data=await resp.json()
        produto.value=data.description||''
        marca.value=data.brand ? data.brand.name : ''
        atualizarBotaoLimpar()
    }catch(e){}
}

function acaoPrincipal(){
    if(editandoIndex!==null) salvarEdicao()
    else cadastrarManual()
}

function cadastrarManual(){
    if(!marca.value||!produto.value||!codigo.value){
        alert("Preencha todos os campos!")
        return
    }
    produtos.push({marca:marca.value,produto:produto.value,codigo:codigo.value})
    salvarLocal()
    limparCampos()
    listar()
}

function editar(index){
    editandoIndex=index
    marca.value=produtos[index].marca
    produto.value=produtos[index].produto
    codigo.value=produtos[index].codigo
    btnCadastrar.innerText="Salvar"
    atualizarBotaoLimpar()
}

function salvarEdicao(){
    produtos[editandoIndex]={
        marca:marca.value,
        produto:produto.value,
        codigo:codigo.value
    }
    salvarLocal()
    limparCampos()
    listar()
}

function excluir(index){
    if(confirm("Deseja excluir este produto?")){
        produtos.splice(index,1)
        salvarLocal()
        listar()
    }
}

function listar(){
    if(table) table.destroy()
    var tbody=$("#produtosTable tbody")
    tbody.empty()

    produtos.forEach((p,i)=>{
        tbody.append(`<tr>
            <td>${p.marca}</td>
            <td>${p.produto}</td>
            <td><span class="codigo-click" onclick="gerarBarcode('${p.codigo}')">${p.codigo}</span></td>
            <td>
                <button class="btn btn-sm btn-edit me-1" onclick="editar(${i})">Editar</button>
                <button class="btn btn-sm btn-delete" onclick="excluir(${i})">Excluir</button>
            </td>
        </tr>`)
    })

    table=$('#produtosTable').DataTable({
        language:{ url:'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json' },
        paging:false,
        info:false,
        searching:true,
        dom:'t'
    })
}

document.getElementById("buscaExterna")
.addEventListener("keyup", function(){
    table.search(this.value).draw()
})

function gerarBarcode(cod){
    modalBarcode.style.display='flex'
    codigoTexto.innerText = cod

    let formato="CODE128"
    if(cod.length===13 && /^\d+$/.test(cod)){
        formato="EAN13"
    }

    JsBarcode("#barcode", cod, {
        format:formato,
        width:3,
        height:180,
        displayValue:false,
        margin:20
    })
}

function fecharBarcode(){
    modalBarcode.style.display='none'
}

function abrirCamera(){
    modalCamera.style.display='flex'
    html5QrCode = new Html5Qrcode("reader")

    html5QrCode.start(
        {facingMode:"environment"},
        {fps:20, qrbox:{width:280,height:150}},
        function(decodedText){
            codigo.value=decodedText
            beep()
            buscarProduto(decodedText)
            atualizarBotaoLimpar()
            fecharCamera()
        }
    )
}

function fecharCamera(){
    if(html5QrCode){
        html5QrCode.stop().then(()=>{
            modalCamera.style.display='none'
        })
    }
}

codigo.addEventListener("input", function(){
    atualizarBotaoLimpar()
    buscarProduto(codigo.value)
})

marca.addEventListener("input", atualizarBotaoLimpar)
produto.addEventListener("input", atualizarBotaoLimpar)

listar()
</script>

</body>
</html>