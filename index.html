<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
* { box-sizing: border-box; font-family: Arial }
body { margin:0; background:#fee2e2 }

.app {
    max-width:420px;
    margin:auto;
    min-height:100vh;
    background:#fff;
}

.topbar {
    background:#b91c1c;
    color:#fff;
    padding:16px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
}

.area { padding:12px }

select, input, button {
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid #ccc;
    margin-bottom:10px;
}

button {
    background:#b91c1c;
    color:#fff;
    border:none;
    cursor:pointer;
}

.lista { padding:12px }

.item {
    background:#fff;
    padding:14px;
    border-radius:16px;
    margin-bottom:12px;
    box-shadow:0 6px 15px rgba(0,0,0,.15);
}

.codigo {
    margin-top:6px;
    color:#2563eb;
    cursor:pointer;
}

.fab {
    position:fixed;
    bottom:20px;
    right:20px;
    width:56px;
    height:56px;
    border-radius:50%;
    border:none;
    font-size:30px;
    background:#dc2626;
    color:#fff;
}

.modal {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    justify-content:center;
    align-items:center;
}

.modal-content {
    background:#fff;
    width:90%;
    max-width:380px;
    border-radius:18px;
    padding:18px;
    text-align:center;
}

.codigo-grande {
    font-size:28px;
    font-weight:bold;
    margin:10px 0;
}

#camera {
    width:100%;
    height:250px;
}
</style>
</head>

<body>

<div class="app">
    <div class="topbar"> Produtos</div>

    <div class="area">
        <select id="filtroMarca" onchange="buscar()">
            <option value="">Todas as marcas</option>
        </select>

        <input id="filtroNome" placeholder="Buscar pelo nome do produto" onkeyup="buscar()">

        <button onclick="abrirCadastro()">Cadastrar produto</button>
    </div>

    <div class="lista" id="lista"></div>
</div>

<button class="fab" onclick="abrirCadastro()">+</button>

<!-- MODAL CADASTRO -->
<div class="modal" id="modalCadastro">
    <div class="modal-content">
        <h3>Cadastro</h3>
        <input id="marca" placeholder="Marca">
        <input id="nome" placeholder="Nome do produto">
        <input id="codigo" placeholder="C贸digo (somente n煤meros)" inputmode="numeric">
        <button onclick="abrirCamera()"> Ler c贸digo</button>
        <button onclick="salvar()">Salvar</button>
        <button onclick="fechar()">Cancelar</button>
    </div>
</div>

<!-- MODAL CDIGO -->
<div class="modal" id="modalCodigo">
    <div class="modal-content">
        <div class="codigo-grande" id="codigoGrande"></div>
        <div id="nomeProduto"></div>
        <svg id="barcode"></svg>
        <br><br>
        <button onclick="fechar()">Fechar</button>
    </div>
</div>

<!-- MODAL CMERA -->
<div class="modal" id="modalCamera">
    <div class="modal-content">
        <h3>Leia o c贸digo</h3>
        <div id="camera"></div>
        <button onclick="fecharCamera()">Cancelar</button>
    </div>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let quaggaAtivo = false;

/* SOMENTE NMEROS */
codigo.addEventListener("input", () => {
    codigo.value = codigo.value.replace(/\D/g, "");
});

function ordenar() {
    produtos.sort((a,b) =>
        a.marca.localeCompare(b.marca) ||
        a.nome.localeCompare(b.nome)
    );
}

function render(listaFiltrada = produtos) {
    lista.innerHTML = "";
    listaFiltrada.forEach(p => {
        lista.innerHTML += `
            <div class="item">
                <strong>${p.marca} - ${p.nome}</strong>
                <div class="codigo" onclick="mostrarCodigo('${p.codigo}','${p.nome}')">
                    C贸digo: ${p.codigo}
                </div>
            </div>
        `;
    });
}

function atualizarMarcas() {
    let marcas = [...new Set(produtos.map(p => p.marca))].sort();
    filtroMarca.innerHTML = `<option value="">Todas as marcas</option>`;
    marcas.forEach(m => filtroMarca.innerHTML += `<option>${m}</option>`);
}

/*  BUSCA POR MARCA + NOME */
function buscar() {
    let marcaSelecionada = filtroMarca.value.toLowerCase();
    let nomeDigitado = filtroNome.value.toLowerCase();

    let filtrado = produtos.filter(p =>
        (marcaSelecionada === "" || p.marca.toLowerCase() === marcaSelecionada) &&
        p.nome.toLowerCase().includes(nomeDigitado)
    );

    filtrado.length ? render(filtrado) : render([]);
}

function abrirCadastro() {
    marca.value = filtroMarca.value || "";
    nome.value = "";
    codigo.value = "";
    modalCadastro.style.display = "flex";
}

function salvar() {
    if (!marca.value || !nome.value || !codigo.value) return;

    produtos.push({
        marca: marca.value,
        nome: nome.value,
        codigo: codigo.value
    });

    ordenar();
    localStorage.setItem("produtos", JSON.stringify(produtos));
    atualizarMarcas();
    buscar();
    fechar();
}

function mostrarCodigo(cod, nomeProd) {
    codigoGrande.innerText = cod;
    nomeProduto.innerText = nomeProd;

    JsBarcode("#barcode", cod, {
        format: "CODE128",
        height: 90,
        displayValue: true
    });

    modalCodigo.style.display = "flex";
}

/*  CMERA */
function abrirCamera() {
    modalCamera.style.display = "flex";

    if (quaggaAtivo) {
        Quagga.stop();
        quaggaAtivo = false;
    }

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: {
                facingMode: "environment"
            }
        },
        decoder: {
            readers: ["code_128_reader","ean_reader","ean_8_reader"]
        }
    }, err => {
        if (err) return alert("Erro ao acessar c芒mera");
        quaggaAtivo = true;
        Quagga.start();
    });

    Quagga.onDetected(data => {
        codigo.value = data.codeResult.code;
        fecharCamera();
    });
}

function fecharCamera() {
    if (quaggaAtivo) {
        Quagga.stop();
        quaggaAtivo = false;
    }
    modalCamera.style.display = "none";
}

function fechar() {
    modalCadastro.style.display = "none";
    modalCodigo.style.display = "none";
}

ordenar();
atualizarMarcas();
render();
</script>

</body>
</html>